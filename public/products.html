<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gudang - HaziPos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen relative" x-data="productApp()" x-init="initData()">

    <div class="fixed top-0 left-0 right-0 bg-gray-900/90 backdrop-blur-md border-b border-gray-800 z-40 px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="/dashboard.html" class="p-2 bg-gray-800 rounded-lg text-gray-400 hover:text-white transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </a>
            <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Manajemen Produk</h1>
        </div>
        <div class="relative">
            <input x-model="search" type="text" placeholder="Cari barang..." class="bg-gray-800 text-xs rounded-full px-4 py-2 w-32 focus:w-48 transition-all border border-gray-700 focus:border-blue-500 outline-none text-white">
        </div>
    </div>

    <div class="pt-20 pb-24 px-4 max-w-2xl mx-auto">
        
        <div x-show="isLoading" class="text-center py-10 text-gray-500 animate-pulse">
            Memuat data gudang...
        </div>

        <div x-show="!isLoading && filteredProducts.length === 0" class="text-center py-20">
            <div class="inline-block p-4 rounded-full bg-gray-800 text-gray-500 mb-3">üì¶</div>
            <p class="text-gray-400 text-sm">Belum ada produk.</p>
        </div>

        <div class="space-y-3">
            <template x-for="p in filteredProducts" :key="p.id">
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex justify-between items-start active:scale-[0.99] transition-transform">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-mono bg-gray-800 text-gray-400 px-1.5 py-0.5 rounded" x-text="p.barcode || '-'"></span>
                            <span class="text-xs bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded-full" x-text="p.category || 'Umum'"></span>
                        </div>
                        <h3 class="font-bold text-white text-base" x-text="p.name"></h3>
                        <div class="text-xs text-gray-400 mt-1 space-x-2">
                            <span>Stok: <b x-text="p.stock" :class="p.stock < 5 ? 'text-red-500' : 'text-green-400'"></b></span>
                            <span>|</span>
                            <span>Modal: <span x-text="formatRupiah(p.cost_price)"></span></span>
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end gap-2">
                        <span class="font-bold text-lg text-blue-400" x-text="formatRupiah(p.selling_price)"></span>
                        <div class="flex gap-2">
                            <button @click="editProduct(p)" class="p-1.5 bg-gray-800 text-yellow-500 rounded-lg hover:bg-gray-700">‚úèÔ∏è</button>
                            <button @click="deleteProduct(p.id)" class="p-1.5 bg-gray-800 text-red-500 rounded-lg hover:bg-gray-700">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <button @click="openModal()" class="fixed bottom-6 right-6 bg-gradient-to-r from-blue-600 to-purple-600 w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-blue-600/40 z-30 hover:scale-110 transition-transform">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
    </button>

    <div x-show="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm" x-transition.opacity style="display: none;">
        <div class="bg-gray-900 w-full sm:w-[400px] sm:rounded-2xl rounded-t-3xl border border-gray-800 p-6 relative" @click.away="closeModal()" x-transition.move.bottom>
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white" x-text="isEdit ? 'Edit Produk' : 'Tambah Produk Baru'"></h2>
                <button @click="closeModal()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>

            <div class="space-y-4 overflow-y-auto max-h-[70vh] pb-10">
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-1">
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Barcode</label>
                        <input x-model="form.barcode" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Nama Barang</label>
                        <input x-model="form.name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: Kopi Sachet">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Kategori</label>
                        <select x-model="form.category" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm outline-none">
                            <template x-for="cat in categories" :key="cat.id">
                                <option :value="cat.name" x-text="cat.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Stok Awal</label>
                        <input x-model="form.stock" type="number" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm outline-none">
                    </div>
                </div>

                <div class="p-3 bg-gray-800/50 rounded-xl border border-gray-700/50 space-y-3">
                    <div>
                        <label class="text-[10px] text-green-400 uppercase font-bold">Harga Jual (Ke Pembeli)</label>
                        <input x-model="form.selling_price" type="number" class="w-full bg-gray-900 border border-green-900/50 text-green-400 font-bold rounded-lg px-3 py-2 outline-none focus:border-green-500" placeholder="Rp 0">
                    </div>
                    <div>
                        <label class="text-[10px] text-yellow-500 uppercase font-bold">Harga Modal (Rahasia)</label>
                        <input x-model="form.cost_price" type="number" class="w-full bg-gray-900 border border-yellow-900/50 text-yellow-500 rounded-lg px-3 py-2 outline-none focus:border-yellow-500" placeholder="Rp 0">
                    </div>
                </div>

                <button @click="saveProduct()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-600/30 transition-all">
                    <span x-text="isEdit ? 'Simpan Perubahan' : 'Simpan Produk'"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        function productApp() {
            return {
                products: [], categories: [], // Array untuk kategori dinamis
                search: '',
                isLoading: true,
                showModal: false,
                isEdit: false,
                
                form: { id: null, barcode: '', name: '', category: '', stock: 0, cost_price: 0, selling_price: 0 },

                async initData() {
                    const user = JSON.parse(localStorage.getItem('user'));
                    if(!user || user.role !== 'admin') {
                        alert("Akses Ditolak! Hanya Admin yang boleh masuk gudang.");
                        window.location.href = '/dashboard.html';
                        return;
                    }
                    // Fetch data
                    await this.fetchCategories(); 
                    await this.fetchProducts();
                },

                // Ambil daftar kategori dari Backend
                async fetchCategories() {
                    try {
                        const res = await fetch('/api/settings/categories');
                        this.categories = await res.json();
                        // Set default kategori ke urutan pertama kalau ada
                        if(this.categories.length > 0) {
                            this.form.category = this.categories[0].name;
                        }
                    } catch(e) { console.error("Gagal load kategori", e); }
                },

                async fetchProducts() {
                    this.isLoading = true;
                    try {
                        const res = await fetch('/api/products');
                        const json = await res.json();
                        this.products = json.data;
                    } catch(e) { console.error(e); }
                    this.isLoading = false;
                },

                get filteredProducts() {
                    if (this.search === '') return this.products;
                    return this.products.filter(p => p.name.toLowerCase().includes(this.search.toLowerCase()) || (p.barcode && p.barcode.includes(this.search)));
                },

                openModal() {
                    this.isEdit = false;
                    // Reset form & set kategori default ke item pertama
                    const defaultCat = this.categories.length > 0 ? this.categories[0].name : '';
                    this.form = { id: null, barcode: '', name: '', category: defaultCat, stock: 0, cost_price: 0, selling_price: 0 };
                    this.showModal = true;
                },

                closeModal() { this.showModal = false; },

                editProduct(p) {
                    this.isEdit = true;
                    this.form = { ...p };
                    this.showModal = true;
                },

                async saveProduct() {
                    if(!this.form.name || !this.form.selling_price) return alert("Nama dan Harga Jual wajib diisi!");
                    const url = this.isEdit ? `/api/products/${this.form.id}` : '/api/products';
                    const method = this.isEdit ? 'PUT' : 'POST';

                    await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });

                    this.closeModal();
                    this.fetchProducts();
                },

                async deleteProduct(id) {
                    if(!confirm("Yakin ingin menghapus produk ini?")) return;
                    await fetch(`/api/products/${id}`, { method: 'DELETE' });
                    this.fetchProducts();
                },

                formatRupiah(num) {
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0);
                }
            }
        }
    </script>
</body>
</html>